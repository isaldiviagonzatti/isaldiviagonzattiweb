{{ define "main" }}
<main class="page-main pa4" role="main">
  <section class="page-content mw8 center">

    <!-- Page Title -->
    <header class="page-header bb b--black-10 bw1 pb4 mb5">
      <h1 class="f2 f1-m f-headline-l fw5-ns mv4 lh-solid tracked-tight-ns db">{{ .Title }}</h1>
      {{ with .Content }}
      <div class="pt2 f4 measure-wide lh-copy">{{ . | markdownify }}</div>
      {{ end }}
    </header>

    <!-- Filter Section -->
    <div class="filter-section mb4 pa3 br3">
      <div class="flex flex-wrap items-center mb3">
        <label for="keyword-search" class="f5 fw6 mr3 mb2">Search:</label>
        <input
          type="text"
          id="keyword-search"
          placeholder="Search by keyword..."
          class="f5 pa2 br2 ba b--black-20 mr3 mb2 flex-auto mw5"
        >
        <button id="clear-search" class="f6 pa2 br2 ba b--black-20 pointer mb2 dn">Clear</button>
      </div>
      <div class="flex flex-wrap items-center">
        <label for="author-filter" class="f5 fw6 mr3 mb2">Filter by author:</label>
        <select id="author-filter" class="f5 pa2 br2 ba b--black-20 mr3 mb2">
          <option value="">All authors</option>
          {{ $authors := slice }}
          {{ range .Pages }}
            {{ range .Params.authors }}
              {{ $authors = $authors | append . }}
            {{ end }}
          {{ end }}
          {{ range ($authors | uniq | sort) }}
          <option value="{{ . }}">{{ . }}</option>
          {{ end }}
        </select>

        <label for="type-filter" class="f5 fw6 mr3 mb2">Filter by type:</label>
        <select id="type-filter" class="f5 pa2 br2 ba b--black-20 mr3 mb2">
          <option value="">All types</option>
          {{ $types := slice }}
          {{ range .Pages }}
            {{ if .Params.type }}
              {{ $types = $types | append .Params.type }}
            {{ end }}
          {{ end }}
          {{ range ($types | uniq | sort) }}
          <option value="{{ . }}">{{ . | humanize | title }}</option>
          {{ end }}
        </select>

        <span id="result-count" class="f6 gray mb2"></span>
      </div>
    </div>

    <!-- Anthology Notes -->
    <div id="anthology-container">
      {{ range .Pages }}
      <details class="anthology-item mb3 ba br3" data-authors="{{ delimit .Params.authors "," }}" data-type="{{ .Params.type }}">
        <summary class="pa3 pointer br3 outline-0">
          <div class="flex items-start justify-between">
            <div class="flex-auto">
              <h3 class="f4 fw6 mv0 dark-gray">{{ .Title }}</h3>
              <p class="f5 mv2 gray i">
                {{ if gt (len .Params.authors) 1 }}
                  by {{ delimit .Params.authors ", " " & " }}
                {{ else }}
                  by {{ index .Params.authors 0 }}
                {{ end }}
              </p>
            </div>
            <span class="expand-icon ml3 f4 gray">â–¼</span>
          </div>
        </summary>

        <div class="content pa3 pt0 bt b--black-10">
          <div class="anthology-content f5 lh-copy">
            {{ .Content }}
          </div>
          {{ if or .Params.authors .Params.work .Params.year }}
          <div class="mt3 pt3 bt b--black-10 f6 gray">
            {{ if .Params.authors }}
            <p class="mv1"><strong>Author{{ if gt (len .Params.authors) 1 }}s{{ end }}:</strong> {{ delimit .Params.authors ", " }}</p>
            {{ end }}
            {{ if .Params.work }}
            <p class="mv1"><strong>Work:</strong> {{ .Params.work }}</p>
            {{ end }}
            {{ if .Params.year }}
            <p class="mv1"><strong>Year:</strong> {{ .Params.year }}</p>
            {{ end }}
          </div>
          {{ end }}
        </div>
      </details>
      {{ end }}
    </div>

    <!-- No Results Message -->
    <div id="no-results" class="dn pa4 tc gray">
      <p class="f4">No notes found for the selected author.</p>
    </div>

  </section>
</main>

<!-- Custom Styles and JavaScript -->
<style>
  .anthology-item summary {
    list-style: none;
    user-select: none;
  }

  .anthology-item summary::-webkit-details-marker {
    display: none;
  }

  .anthology-item[open] .expand-icon {
    transform: rotate(180deg);
  }

  .expand-icon {
    transition: transform 0.2s ease;
    font-size: 0.8em;
  }

  .anthology-content {
    white-space: normal;
  }

  /* Reduce spacing for paragraphs and headings */
  .anthology-content p {
    margin-top: 0;
    margin-bottom: 0.75rem;
  }

  .anthology-content p:last-child {
    margin-bottom: 0;
  }

  .anthology-content h1,
  .anthology-content h2,
  .anthology-content h3,
  .anthology-content h4,
  .anthology-content h5,
  .anthology-content h6 {
    margin-top: 1rem;
    margin-bottom: 0.5rem;
  }

  .anthology-content h1:first-child,
  .anthology-content h2:first-child,
  .anthology-content h3:first-child {
    margin-top: 0;
  }

  /* Reduce spacing between content and metadata */
  .content > div:last-child {
    margin-top: 1rem !important;
    padding-top: 1rem !important;
  }

  .anthology-item {
    transition: box-shadow 0.2s ease;
  }

  .anthology-item:hover {
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
  }

  .anthology-item.hidden {
    display: none !important;
  }

  /* Light mode (default) styles */
  .anthology-item {
    background-color: #ffffff;
    border-color: rgba(0,0,0,0.1);
    color: #17261E;
  }

  .filter-section {
    background-color: #f4f4f4;
  }

  .filter-section input,
  .filter-section select,
  .filter-section button {
    background-color: #ffffff;
    color: #17261E;
  }

  /* Dark mode styles */
  .dark-mode .anthology-item {
    background-color: #17261E;
    border-color: #558B71;
    color: #F3F3EE;
  }

  .dark-mode .filter-section {
    background-color: #17261E;
    border: 1px solid #558B71;
  }

  .dark-mode .filter-section input,
  .dark-mode .filter-section select,
  .dark-mode .filter-section button {
    background-color: #1F3329;
    color: #F3F3EE;
    border-color: #558B71;
  }

  .dark-mode .anthology-item summary:hover {
    background-color: #2F4C3E;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const authorFilter = document.getElementById('author-filter');
    const typeFilter = document.getElementById('type-filter');
    const searchInput = document.getElementById('keyword-search');
    const clearButton = document.getElementById('clear-search');
    const anthologyItems = document.querySelectorAll('.anthology-item');
    const resultCount = document.getElementById('result-count');
    const noResults = document.getElementById('no-results');

    function updateResultCount(count, searchActive) {
      if (searchActive) {
        resultCount.textContent = `Found ${count} ${count === 1 ? 'note' : 'notes'}`;
      } else if (authorFilter.value === '' && typeFilter.value === '') {
        resultCount.textContent = `Showing all ${count} notes`;
      } else {
        resultCount.textContent = `Showing ${count} ${count === 1 ? 'note' : 'notes'}`;
      }
    }

    function filterNotes() {
      const selectedAuthor = authorFilter.value.toLowerCase();
      const selectedType = typeFilter.value.toLowerCase();
      const searchTerm = searchInput.value.toLowerCase().trim();
      let visibleCount = 0;

      anthologyItems.forEach(item => {
        const authors = item.dataset.authors.toLowerCase();
        const itemType = (item.dataset.type || '').toLowerCase();
        const title = item.querySelector('h3').textContent.toLowerCase();
        const content = item.querySelector('.anthology-content').textContent.toLowerCase();

        // Check author filter
        const matchesAuthor = selectedAuthor === '' || authors.includes(selectedAuthor);

        // Check type filter
        const matchesType = selectedType === '' || itemType === selectedType;

        // Check keyword search (searches in title, author, and content)
        const matchesSearch = searchTerm === '' ||
                             title.includes(searchTerm) ||
                             authors.includes(searchTerm) ||
                             content.includes(searchTerm);

        // Item is visible only if it matches all filters
        if (matchesAuthor && matchesType && matchesSearch) {
          item.classList.remove('hidden');
          visibleCount++;
        } else {
          item.classList.add('hidden');
        }
      });

      // Show/hide no results message
      if (visibleCount === 0) {
        noResults.classList.remove('dn');
        noResults.querySelector('p').textContent = searchTerm ?
          'No notes found matching your search.' :
          'No notes found for the selected filters.';
      } else {
        noResults.classList.add('dn');
      }

      // Show/hide clear button
      if (searchTerm) {
        clearButton.classList.remove('dn');
      } else {
        clearButton.classList.add('dn');
      }

      updateResultCount(visibleCount, searchTerm !== '');
    }

    function clearSearch() {
      searchInput.value = '';
      filterNotes();
      searchInput.focus();
    }

    // Initialize count
    updateResultCount(anthologyItems.length, false);

    // Add event listeners
    authorFilter.addEventListener('change', filterNotes);
    typeFilter.addEventListener('change', filterNotes);
    searchInput.addEventListener('input', filterNotes);
    clearButton.addEventListener('click', clearSearch);

    // Allow Enter key to search
    searchInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
      }
    });
  });
</script>
{{ end }}
